<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 자동 번역기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Noto Sans JP', 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
        }
        .panel {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: #fafafa;
        }
        .panel-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .panel-body {
            padding: 1.5rem;
        }
        .panel-body textarea {
            resize: none;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            outline: none;
            width: 100%;
            padding: 0.75rem;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #374151;
            transition: border-color 0.2s;
        }
        .panel-body textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .output-area {
            min-height: 10rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            position: relative;
        }
        .pronunciation {
            font-size: 0.7em;
            color: #4b5563;
            margin-left: 0.5rem;
        }
        .output-area p {
             line-height: 1.8;
        }
        .loader-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .loader-container.visible {
            opacity: 1;
        }
        .loader {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .lang-btn.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        #word-study-section {
            display: none;
        }
        .word-study-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.25rem 1.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto space-y-6">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">AI 자동 감지 번역기</h1>
            <p class="mt-2 text-gray-600">번역할 내용을 입력하고 언어를 선택한 후 버튼을 눌러주세요.</p>
        </header>

        <main class="space-y-6">
            <!-- 입력 패널 -->
            <div class="panel">
                <div class="panel-header">
                    <h2><i class="fas fa-keyboard mr-2 text-blue-500"></i>번역할 내용 (자동 언어 감지)</h2>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-sm text-gray-500">Ctrl+Enter로 빠른 번역</span>
                        <span id="char-counter" class="text-sm text-gray-500">0/5000</span>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea id="source-text-input" rows="5" placeholder="한국어, 영어, 일본어, 중국어로 내용을 입력하세요..."></textarea>
                </div>
            </div>

            <!-- 컨트롤 패널 -->
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <div id="lang-selector" class="flex-shrink-0 flex items-center bg-white rounded-full p-1 shadow-sm">
                    <button data-lang="Japanese" class="lang-btn active px-4 py-2 text-sm rounded-full transition-colors">일본어</button>
                    <button data-lang="Chinese" class="lang-btn px-4 py-2 text-sm rounded-full transition-colors">중국어</button>
                    <button data-lang="English" class="lang-btn px-4 py-2 text-sm rounded-full transition-colors">영어</button>
                </div>
                <button id="translate-btn" class="w-full sm:w-auto flex-grow bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-language mr-2"></i>번역하기
                </button>
            </div>

            <!-- 번역 결과 패널 -->
            <div class="panel">
                <div class="panel-header">
                    <h2 id="target-lang-title"><i class="fas fa-check-circle mr-2 text-green-500"></i>번역 결과</h2>
                </div>
                <div class="panel-body output-area">
                    <div id="target-output-content" class="space-y-2"></div>
                    <div id="word-study-section" class="mt-4 pt-4 border-t border-gray-200">
                        <h3 class="font-semibold text-gray-700 mb-2">단어 학습</h3>
                        <div id="word-study-list" class="text-sm word-study-grid"></div>
                    </div>
                    <div id="target-loader" class="loader-container"><div class="loader"></div></div>
                </div>
            </div>
            
            <!-- 한국어 결과 패널 -->
            <div class="panel">
                <div class="panel-header">
                    <h2><i class="fas fa-check-circle mr-2 text-blue-500"></i>한국어 결과</h2>
                </div>
                <div class="panel-body output-area">
                    <div id="korean-output-content" class="space-y-2"></div>
                     <div id="korean-loader" class="loader-container"><div class="loader"></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- 메시지 모달 -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm">
            <h3 id="message-title" class="text-xl font-bold mb-4 text-red-600">오류</h3>
            <p id="message-content" class="text-gray-700 mb-6"></p>
            <button id="message-close-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">확인</button>
        </div>
    </div>

<script>
    const sourceTextInput = document.getElementById('source-text-input');
    const targetOutputContent = document.getElementById('target-output-content');
    const koreanOutputContent = document.getElementById('korean-output-content');
    const targetLangTitle = document.getElementById('target-lang-title');
    const targetLoader = document.getElementById('target-loader');
    const koreanLoader = document.getElementById('korean-loader');
    const langSelector = document.getElementById('lang-selector');
    const translateBtn = document.getElementById('translate-btn');
    const messageModal = document.getElementById('message-modal');
    const messageContent = document.getElementById('message-content');
    const messageCloseBtn = document.getElementById('message-close-btn');
    const wordStudySection = document.getElementById('word-study-section');
    const wordStudyList = document.getElementById('word-study-list');

    let currentTargetLanguage = 'Japanese';
    let isTranslating = false; // 번역 중 상태 관리
    let debounceTimer = null; // 디바운스 타이머

    const langDisplayNames = {
        Japanese: '일본어 (Japanese)',
        Chinese: '중국어 (Chinese)',
        English: '영어 (English)'
    };

    langSelector.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            langSelector.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            currentTargetLanguage = e.target.dataset.lang;
            targetLangTitle.innerText = `${langDisplayNames[currentTargetLanguage]} 번역 결과`;
        }
    });

    // 유틸리티 함수들
    function showMessage(content, type = 'error') {
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        
        messageTitle.textContent = type === 'error' ? '오류' : '알림';
        messageTitle.className = type === 'error' ? 'text-xl font-bold mb-4 text-red-600' : 'text-xl font-bold mb-4 text-blue-600';
        messageContent.textContent = content;
        messageModal.classList.remove('hidden');
    }
    
    // HTML 이스케이프 함수
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }
    
    // 텍스트 검증 함수
    function validateText(text) {
        if (!text || !text.trim()) {
            return { valid: false, message: '번역할 내용을 입력해주세요.' };
        }
        
        if (text.length > 5000) {
            return { valid: false, message: '텍스트가 너무 깁니다. 5000자 이하로 입력해주세요.' };
        }
        
        if (text.trim().length < 1) {
            return { valid: false, message: '번역할 내용이 너무 짧습니다.' };
        }
        
        // 악성 스크립트 검증
        const dangerousPatterns = [
            /<script/i,
            /javascript:/i,
            /vbscript:/i,
            /onload\s*=/i,
            /onerror\s*=/i,
            /onclick\s*=/i
        ];
        
        for (const pattern of dangerousPatterns) {
            if (pattern.test(text)) {
                return { valid: false, message: '유효하지 않은 입력입니다.' };
            }
        }
        
        return { valid: true };
    }
    messageCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));

    async function translateText() {
        // 이미 번역 중이면 중복 요청 방지
        if (isTranslating) {
            showMessage('번역이 진행 중입니다. 잠시만 기다려 주세요.');
            return;
        }

        const text = sourceTextInput.value;
        
        // 텍스트 검증
        const validation = validateText(text);
        if (!validation.valid) {
            showMessage(validation.message);
            return;
        }

        // 번역 시작 상태 설정
        isTranslating = true;
        translateBtn.disabled = true;
        translateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>번역 중...';
        
        targetLoader.classList.add('visible');
        koreanLoader.classList.add('visible');
        targetOutputContent.innerHTML = '';
        koreanOutputContent.innerHTML = '';
        wordStudySection.style.display = 'none';
        wordStudyList.innerHTML = '';

        try {
            // 타임아웃 설정 (35초)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 35000);

            // Vercel API 엔드포인트로 요청
            const response = await fetch('/api/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    targetLanguage: currentTargetLanguage
                }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `API 요청 실패: ${response.status}`);
            }

            const result = await response.json();
            
            if (!result.success || !result.data) {
                throw new Error("API 응답 형식이 올바르지 않습니다.");
            }

            const translationData = result.data;
            
            const formatOutput = (lines) => {
                if (lines && Array.isArray(lines)) {
                    return lines.map(line => {
                        const translation = escapeHtml(line.translation || '');
                        const pronunciation = escapeHtml(line.pronunciation || '');
                        
                        return `<p class="text-lg">${translation} <span class="pronunciation">(${pronunciation})</span></p>`;
                    }).join('');
                }
                return '';
            };

            targetOutputContent.innerHTML = formatOutput(translationData.targetTranslation);
            koreanOutputContent.innerHTML = formatOutput(translationData.koreanTranslation);

            if ((currentTargetLanguage === 'Japanese' || currentTargetLanguage === 'English' || currentTargetLanguage === 'Chinese') && translationData.wordStudy && translationData.wordStudy.length > 0) {
                const wordListHtml = translationData.wordStudy.map(word => {
                    const originalWord = escapeHtml(word.originalWord);
                    const koreanMeaning = escapeHtml(word.koreanMeaning);
                    const reading = escapeHtml(word.reading);
                    const koreanPronunciation = escapeHtml(word.koreanPronunciation);
                    
                    if (currentTargetLanguage === 'Japanese') {
                        return `<div>${originalWord} (${koreanMeaning}, ${reading}, ${koreanPronunciation})</div>`;
                    } else if (currentTargetLanguage === 'English') {
                        return `<div>${originalWord} (${koreanMeaning}, ${reading})</div>`;
                    } else { // Chinese
                        return `<div>${originalWord} (${koreanMeaning}, ${koreanPronunciation}, ${reading})</div>`;
                    }
                }).join('');
                wordStudyList.innerHTML = wordListHtml;
                wordStudySection.style.display = 'block';
            }

        } catch (error) {
            console.error('번역 오류:', error);
            
            // 에러 타입별 세분화된 메시지
            let errorMessage = '번역 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
            
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                errorMessage = '요청 시간이 초과되었습니다. 텍스트를 줄이고 다시 시도해 주세요.';
            } else if (error.message.includes('fetch failed') || error.message.includes('Failed to fetch')) {
                errorMessage = '네트워크 연결을 확인해 주세요.';
            } else if (error.message.includes('API 요청 실패: 429')) {
                errorMessage = '요청이 너무 많습니다. 잠시 후 다시 시도해 주세요.';
            } else if (error.message.includes('API 요청 실패: 500')) {
                errorMessage = '서버에 일시적인 문제가 발생했습니다.';
            }
            
            showMessage(errorMessage);
            targetOutputContent.innerHTML = '';
            koreanOutputContent.innerHTML = '';
        } finally {
            // 번역 완료 상태로 복원
            isTranslating = false;
            translateBtn.disabled = false;
            translateBtn.innerHTML = '<i class="fas fa-language mr-2"></i>번역하기';
            targetLoader.classList.remove('visible');
            koreanLoader.classList.remove('visible');
        }
    }

    translateBtn.addEventListener('click', translateText);
    
    // Enter 키로 번역 실행 (Ctrl+Enter)
    sourceTextInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            translateText();
        }
    });
    
    // 실시간 문자 수 카운터 추가
    sourceTextInput.addEventListener('input', (e) => {
        const text = e.target.value;
        const length = text.length;
        
        // 문자 수 표시 요소가 있다면 업데이트
        const charCounter = document.getElementById('char-counter');
        if (charCounter) {
            charCounter.textContent = `${length}/5000`;
            charCounter.className = length > 5000 ? 'text-red-500 text-sm' : 'text-gray-500 text-sm';
        }
    });
    
    targetLangTitle.innerText = `${langDisplayNames[currentTargetLanguage]} 번역 결과`;

</script>
</body>
</html>
