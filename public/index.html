<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 자동 번역기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Noto Sans JP', 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
        }
        .panel {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        .panel-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: #fafafa;
        }
        .panel-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }
        .panel-body {
            padding: 1.5rem;
        }
        .panel-body textarea {
            resize: none;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            outline: none;
            width: 100%;
            padding: 0.75rem;
            font-size: 1.1rem;
            line-height: 1.8;
            color: #374151;
            transition: border-color 0.2s;
        }
        .panel-body textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .output-area {
            min-height: 10rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1.5rem;
            position: relative;
        }
        .pronunciation {
            font-size: 0.7em;
            color: #4b5563;
            margin-left: 0.5rem;
        }
        .output-area p {
             line-height: 1.8;
        }
        .loader-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .loader-container.visible {
            opacity: 1;
        }
        .loader {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .lang-btn.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
        #word-study-section {
            display: none;
        }
        .word-study-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.25rem 1.5rem;
        }
        
        /* 단어 팝업 스타일 */
        .word-popup {
            position: absolute;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            min-width: 250px;
            max-width: 350px;
            z-index: 1000;
            font-size: 0.9rem;
            line-height: 1.4;
            display: none;
            pointer-events: none;
        }
        
        .word-popup .word-title {
            font-weight: bold;
            font-size: 1.32rem; /* 120% 적용 */
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .word-popup .pronunciation {
            color: #4b5563;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }
        
        .word-popup .example {
            border-top: 1px solid #e5e7eb;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .word-popup .example-label {
            font-weight: bold;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .word-popup .example-text {
            color: #374151;
            margin-bottom: 0.25rem;
        }
        
        .word-popup .example-pronunciation {
            color: #6b7280;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .word-popup .korean-translation {
            color: #374151;
            font-size: 0.85rem;
            border-top: 1px solid #f3f4f6;
            padding-top: 0.5rem;
        }
        
        .hoverable-word {
            cursor: pointer;
            padding: 0.1rem 0.2rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        
        .hoverable-word:hover {
            background-color: #dbeafe;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-3xl mx-auto space-y-6">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
                <i class="fas fa-language mr-3 text-blue-600"></i>
                AI 자동 번역기
            </h1>
            <p class="mt-2 text-gray-600">전문 기술 번역 서비스</p>
            <div class="mt-2 flex justify-center items-center text-sm text-blue-600">
                <i class="fas fa-check-circle mr-1"></i>
                <span> </span>
            </div>
        </header>

        <main class="space-y-6">
            <!-- 입력 패널 -->
            <div class="panel">
                <div class="panel-header">
                    <h2><i class="fas fa-keyboard mr-2 text-blue-500"></i>번역할 내용 (자동 언어 감지)</h2>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-sm text-gray-500"></span>
                        <span id="char-counter" class="text-sm text-gray-500">0/5000</span>
                    </div>
                </div>
                <div class="panel-body">
                    <textarea id="source-text-input" rows="5" placeholder="한국어, 영어, 일본어, 중국어로 내용을 입력하세요..."></textarea>
                </div>
            </div>

            <!-- 컨트롤 패널 -->
            <div class="flex flex-col gap-4">
                <!-- 언어 선택 및 번역 버튼 -->
                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div id="lang-selector" class="flex-shrink-0 flex items-center bg-white rounded-full p-1 shadow-sm">
                        <button data-lang="Japanese" class="lang-btn active px-4 py-2 text-sm rounded-full transition-colors">일본어</button>
                        <button data-lang="Chinese" class="lang-btn px-4 py-2 text-sm rounded-full transition-colors">중국어</button>
                        <button data-lang="English" class="lang-btn px-4 py-2 text-sm rounded-full transition-colors">영어</button>
                    </div>
                    <button id="translate-btn" class="w-full sm:w-auto flex-grow bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-language mr-2"></i>번역하기
                    </button>
                </div>
            </div>

            <!-- 번역 결과 패널 -->
            <div class="panel">
                <div class="panel-header">
                    <h2 id="target-lang-title"><i class="fas fa-check-circle mr-2 text-green-500"></i>번역 결과</h2>
                </div>
                <div class="panel-body output-area">
                    <div id="target-output-content" class="space-y-2"></div>
                    <div id="word-study-section" class="mt-4 pt-4 border-t border-gray-200">
                        <h3 class="font-semibold text-gray-700 mb-2">단어 학습</h3>
                        <div id="word-study-list" class="text-sm word-study-grid"></div>
                    </div>
                    <div id="target-loader" class="loader-container"><div class="loader"></div></div>
                </div>
            </div>
            
            <!-- 한국어 결과 패널 -->
            <div class="panel">
                <div class="panel-header">
                    <h2><i class="fas fa-check-circle mr-2 text-blue-500"></i>한국어 결과</h2>
                </div>
                <div class="panel-body output-area">
                    <div id="korean-output-content" class="space-y-2"></div>
                     <div id="korean-loader" class="loader-container"><div class="loader"></div></div>
                </div>
            </div>
            
            <!-- 전문가 모드 및 스타일 설정 -->
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-cogs mr-2 text-purple-500"></i>전문가 번역 설정</h3>
                </div>
                <div class="panel-body">
                    <!-- 전문가 모드 토글 -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-industry mr-2 text-blue-500"></i>
                            <span class="font-medium">자동차 제조업 전문가 모드</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="expert-mode" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    
                    <!-- 번역 스타일 선택 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">번역 스타일</label>
                        <select id="translation-style" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                            <option value="">기본 스타일</option>
                            <option value="business">비즈니스 (전문적)</option>
                            <option value="formal">격식체 (공식적)</option>
                            <option value="academic">학술적 (정확한)</option>
                            <option value="literal">직역 (원문 충실)</option>
                            <option value="creative">창의적 (자연스러운)</option>
                            <option value="casual">일상체 (친근한)</option>
                        </select>
                    </div>
                    
                    <!-- 커스텀 프롬프트 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">추가 번역 지침 (선택사항)</label>
                        <textarea id="custom-prompt" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="예: 기술 문서용으로 번역해주세요, 초보자도 이해할 수 있게 설명을 추가해주세요 등"></textarea>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-500">추가적인 번역 요구사항을 입력하세요</span>
                            <span id="prompt-counter" class="text-xs text-gray-500">0/500</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 단어 팝업 -->
    <div id="word-popup" class="word-popup">
        <div id="popup-word" class="word-title"></div>
        <div id="popup-pronunciation" class="pronunciation"></div>
        <div id="popup-example" class="example">
            <div class="example-label">(예문):</div>
            <div id="popup-example-text" class="example-text"></div>
            <div id="popup-example-pronunciation" class="example-pronunciation"></div>
            <div class="example-label">(예문):</div>
            <div id="popup-korean-translation" class="korean-translation"></div>
        </div>
    </div>

    <!-- 메시지 모달 -->
    <div id="message-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm">
            <h3 id="message-title" class="text-xl font-bold mb-4 text-red-600">오류</h3>
            <p id="message-content" class="text-gray-700 mb-6"></p>
            <button id="message-close-btn" class="bg-blue-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-600">확인</button>
        </div>
    </div>

<script>
    const sourceTextInput = document.getElementById('source-text-input');
    const targetOutputContent = document.getElementById('target-output-content');
    const koreanOutputContent = document.getElementById('korean-output-content');
    const targetLangTitle = document.getElementById('target-lang-title');
    const targetLoader = document.getElementById('target-loader');
    const koreanLoader = document.getElementById('korean-loader');
    const langSelector = document.getElementById('lang-selector');
    const translateBtn = document.getElementById('translate-btn');
    const messageModal = document.getElementById('message-modal');
    const messageContent = document.getElementById('message-content');
    const messageCloseBtn = document.getElementById('message-close-btn');
    const wordStudySection = document.getElementById('word-study-section');
    const wordStudyList = document.getElementById('word-study-list');
    const expertModeToggle = document.getElementById('expert-mode');
    const translationStyleSelect = document.getElementById('translation-style');
    const customPromptTextarea = document.getElementById('custom-prompt');
    const promptCounter = document.getElementById('prompt-counter');
    const wordPopup = document.getElementById('word-popup');
    const popupWord = document.getElementById('popup-word');
    const popupPronunciation = document.getElementById('popup-pronunciation');
    const popupExample = document.getElementById('popup-example');
    const popupExampleText = document.getElementById('popup-example-text');
    const popupExamplePronunciation = document.getElementById('popup-example-pronunciation');
    const popupKoreanTranslation = document.getElementById('popup-korean-translation');

    let currentTargetLanguage = 'Japanese';
    let isTranslating = false; // 번역 중 상태 관리
    let debounceTimer = null; // 디바운스 타이머

    const langDisplayNames = {
        Japanese: '일본어 (Japanese)',
        Chinese: '중국어 (Chinese)',
        English: '영어 (English)'
    };

    langSelector.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            langSelector.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            currentTargetLanguage = e.target.dataset.lang;
            targetLangTitle.innerText = `${langDisplayNames[currentTargetLanguage]} 번역 결과`;
        }
    });

    // 유틸리티 함수들
    function showMessage(content, type = 'error') {
        const messageTitle = document.getElementById('message-title');
        const messageContent = document.getElementById('message-content');
        
        messageTitle.textContent = type === 'error' ? '오류' : '알림';
        messageTitle.className = type === 'error' ? 'text-xl font-bold mb-4 text-red-600' : 'text-xl font-bold mb-4 text-blue-600';
        messageContent.textContent = content;
        messageModal.classList.remove('hidden');
    }
    
    // HTML 이스케이프 함수
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text || '';
        return div.innerHTML;
    }
    
    // 텍스트 검증 함수
    function validateText(text) {
        if (!text || !text.trim()) {
            return { valid: false, message: '번역할 내용을 입력해주세요.' };
        }
        
        if (text.length > 5000) {
            return { valid: false, message: '텍스트가 너무 깁니다. 5000자 이하로 입력해주세요.' };
        }
        
        if (text.trim().length < 1) {
            return { valid: false, message: '번역할 내용이 너무 짧습니다.' };
        }
        
        // 악성 스크립트 검증
        const dangerousPatterns = [
            /<script/i,
            /javascript:/i,
            /vbscript:/i,
            /onload\s*=/i,
            /onerror\s*=/i,
            /onclick\s*=/i
        ];
        
        for (const pattern of dangerousPatterns) {
            if (pattern.test(text)) {
                return { valid: false, message: '유효하지 않은 입력입니다.' };
            }
        }
        
        return { valid: true };
    }
    messageCloseBtn.addEventListener('click', () => messageModal.classList.add('hidden'));

    async function translateText() {
        // 이미 번역 중이면 중복 요청 방지
        if (isTranslating) {
            showMessage('번역이 진행 중입니다. 잠시만 기다려 주세요.');
            return;
        }

        const text = sourceTextInput.value;
        
        // 텍스트 검증
        const validation = validateText(text);
        if (!validation.valid) {
            showMessage(validation.message);
            return;
        }

        // 번역 시작 상태 설정
        isTranslating = true;
        translateBtn.disabled = true;
        translateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>번역 중...';
        
        targetLoader.classList.add('visible');
        koreanLoader.classList.add('visible');
        targetOutputContent.innerHTML = '';
        koreanOutputContent.innerHTML = '';
        wordStudySection.style.display = 'none';
        wordStudyList.innerHTML = '';

        try {
            // 타임아웃 설정 (35초)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 35000);

            // 전문가 모드 및 사용자 설정 가져오기
            const isExpertMode = expertModeToggle.checked;
            const translationStyle = translationStyleSelect.value;
            const customPrompt = customPromptTextarea.value.trim();

            // Vercel API 엔드포인트로 요청
            const requestBody = {
                text: text,
                targetLanguage: currentTargetLanguage
            };

            // 전문가 모드가 활성화된 경우에만 추가 파라미터 전송
            if (isExpertMode) {
                if (translationStyle) {
                    requestBody.translationStyle = translationStyle;
                }
                if (customPrompt) {
                    requestBody.customPrompt = customPrompt;
                }
            }

            const response = await fetch('/api/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `API 요청 실패: ${response.status}`);
            }

            const result = await response.json();
            
            if (!result.success || !result.data) {
                throw new Error("API 응답 형식이 올바르지 않습니다.");
            }

            const translationData = result.data;
            
            const formatOutput = (lines) => {
                if (lines && Array.isArray(lines)) {
                    return lines.map(line => {
                        const translation = escapeHtml(line.translation || '');
                        const pronunciation = escapeHtml(line.pronunciation || '');
                        
                        return `<p class="text-lg">${translation} <span class="pronunciation">(${pronunciation})</span></p>`;
                    }).join('');
                }
                return '';
            };

            targetOutputContent.innerHTML = formatOutput(translationData.targetTranslation);
            koreanOutputContent.innerHTML = formatOutput(translationData.koreanTranslation);
            
            // 번역 결과에 호버 기능 추가
            setTimeout(() => {
                const targetParagraphs = targetOutputContent.querySelectorAll('p');
                targetParagraphs.forEach(p => {
                    const textContent = p.childNodes[0]?.textContent || '';
                    if (textContent.trim()) {
                        makeTextHoverable(textContent.trim(), p.childNodes[0]);
                    }
                });
                
                const koreanParagraphs = koreanOutputContent.querySelectorAll('p');
                koreanParagraphs.forEach(p => {
                    const textContent = p.childNodes[0]?.textContent || '';
                    if (textContent.trim()) {
                        makeTextHoverable(textContent.trim(), p.childNodes[0]);
                    }
                });
            }, 100);

            if ((currentTargetLanguage === 'Japanese' || currentTargetLanguage === 'English' || currentTargetLanguage === 'Chinese') && translationData.wordStudy && translationData.wordStudy.length > 0) {
                const wordListHtml = translationData.wordStudy.map(word => {
                    const originalWord = escapeHtml(word.originalWord);
                    const koreanMeaning = escapeHtml(word.koreanMeaning);
                    const reading = escapeHtml(word.reading);
                    const koreanPronunciation = escapeHtml(word.koreanPronunciation);
                    
                    if (currentTargetLanguage === 'Japanese') {
                        return `<div>${originalWord} (${koreanMeaning}, ${reading}, ${koreanPronunciation})</div>`;
                    } else if (currentTargetLanguage === 'English') {
                        return `<div>${originalWord} (${koreanMeaning}, ${reading})</div>`;
                    } else { // Chinese
                        return `<div>${originalWord} (${koreanMeaning}, ${koreanPronunciation}, ${reading})</div>`;
                    }
                }).join('');
                wordStudyList.innerHTML = wordListHtml;
                wordStudySection.style.display = 'block';
                
                // 단어 학습 섹션에 호버 기능 추가
                setTimeout(() => {
                    const wordStudyItems = wordStudyList.querySelectorAll('div');
                    wordStudyItems.forEach(div => {
                        const textContent = div.textContent || '';
                        if (textContent.trim()) {
                            makeTextHoverable(textContent.trim(), div);
                        }
                    });
                }, 100);
            }

        } catch (error) {
            console.error('번역 오류:', error);
            
            // 에러 타입별 세분화된 메시지
            let errorMessage = '번역 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
            
            if (error.name === 'AbortError' || error.message.includes('timeout')) {
                errorMessage = '요청 시간이 초과되었습니다. 텍스트를 줄이고 다시 시도해 주세요.';
            } else if (error.message.includes('fetch failed') || error.message.includes('Failed to fetch')) {
                errorMessage = '네트워크 연결을 확인해 주세요.';
            } else if (error.message.includes('API 요청 실패: 429')) {
                errorMessage = '요청이 너무 많습니다. 잠시 후 다시 시도해 주세요.';
            } else if (error.message.includes('API 요청 실패: 500')) {
                errorMessage = '서버에 일시적인 문제가 발생했습니다.';
            }
            
            showMessage(errorMessage);
            targetOutputContent.innerHTML = '';
            koreanOutputContent.innerHTML = '';
        } finally {
            // 번역 완료 상태로 복원
            isTranslating = false;
            translateBtn.disabled = false;
            translateBtn.innerHTML = '<i class="fas fa-language mr-2"></i>번역하기';
            targetLoader.classList.remove('visible');
            koreanLoader.classList.remove('visible');
        }
    }

    translateBtn.addEventListener('click', translateText);
    
    // 실시간 문자 수 카운터 추가
    sourceTextInput.addEventListener('input', (e) => {
        const text = e.target.value;
        const length = text.length;
        
        // 문자 수 표시 요소가 있다면 업데이트
        const charCounter = document.getElementById('char-counter');
        if (charCounter) {
            charCounter.textContent = `${length}/5000`;
            charCounter.className = length > 5000 ? 'text-red-500 text-sm' : 'text-gray-500 text-sm';
        }
    });
    
    // 커스텀 프롬프트 문자 수 카운터
    customPromptTextarea.addEventListener('input', (e) => {
        const text = e.target.value;
        const length = text.length;
        promptCounter.textContent = `${length}/500`;
        promptCounter.className = length > 500 ? 'text-red-500 text-xs' : 'text-gray-500 text-xs';
    });
    
    // 전문가 모드 토글 이벤트
    expertModeToggle.addEventListener('change', (e) => {
        const isEnabled = e.target.checked;
        if (isEnabled) {
            showMessage('자동차 제조업 전문가 모드가 활성화되었습니다. 기술적이고 전문적인 번역을 제공합니다.', 'info');
        }
    });

    // 단어 팝업 관련 함수들
    function createHoverableWord(word, wordData) {
        const span = document.createElement('span');
        span.textContent = word;
        span.className = 'hoverable-word';
        span.dataset.word = word;
        if (wordData) {
            span.dataset.wordData = JSON.stringify(wordData);
        }
        
        span.addEventListener('mouseenter', (e) => showWordPopup(e, word, wordData));
        span.addEventListener('mouseleave', hideWordPopup);
        
        return span;
    }
    
    async function showWordPopup(event, word, existingData = null) {
        if (existingData) {
            displayPopup(event, word, existingData);
            return;
        }
        
        // 사전 API 호출로 단어 정보 가져오기
        try {
            const wordInfo = await getWordInfo(word);
            displayPopup(event, word, wordInfo);
        } catch (error) {
            console.error('단어 정보 가져오기 실패:', error);
            // 기본 정보로 팝업 표시
            displayPopup(event, word, {
                koreanPronunciation: '발음 정보 없음',
                romanization: '발음 정보 없음',
                example: `${word}를 사용한 예문입니다.`,
                examplePronunciation: '예문 발음',
                koreanTranslation: '예문 번역'
            });
        }
    }
    
    function displayPopup(event, word, wordInfo) {
        console.log('displayPopup called with:', word, wordInfo); // 디버깅용
        popupWord.textContent = word;
        popupPronunciation.textContent = `(${wordInfo.romanization})`;
        popupExampleText.textContent = wordInfo.example;
        popupExamplePronunciation.textContent = `(${wordInfo.examplePronunciation})`;
        popupKoreanTranslation.textContent = wordInfo.koreanTranslation;
        
        // 팝업 위치 계산
        const rect = event.target.getBoundingClientRect();
        const popupRect = wordPopup.getBoundingClientRect();
        
        let left = rect.left + window.scrollX;
        let top = rect.bottom + window.scrollY + 5;
        
        // 화면 경계 확인 및 조정
        if (left + 300 > window.innerWidth) {
            left = window.innerWidth - 320;
        }
        if (top + 150 > window.innerHeight + window.scrollY) {
            top = rect.top + window.scrollY - 160;
        }
        
        wordPopup.style.left = left + 'px';
        wordPopup.style.top = top + 'px';
        wordPopup.style.display = 'block';
    }
    
    function hideWordPopup() {
        wordPopup.style.display = 'none';
    }
    
    async function getWordInfo(word) {
        const wordData = {
            koreanPronunciation: '',
            romanization: '',
            example: '',
            examplePronunciation: '',
            koreanTranslation: ''
        };
        
        // 언어별 처리
        if (currentTargetLanguage === 'Japanese') {
            const jpData = getJapaneseWordData(word);
            console.log('Japanese word data:', word, jpData); // 디버깅용
            wordData.koreanPronunciation = jpData.korean;
            wordData.romanization = jpData.romaji + ' + ' + jpData.hiragana;
            wordData.example = jpData.example;
            wordData.examplePronunciation = jpData.examplePronunciation;
            wordData.koreanTranslation = jpData.koreanTranslation;
            console.log('Final wordData:', wordData); // 디버깅용
        } else if (currentTargetLanguage === 'English') {
            const enData = getEnglishWordData(word);
            wordData.koreanPronunciation = enData.korean;
            wordData.romanization = enData.phonetic + ' + ' + enData.korean;
            wordData.example = enData.example;
            wordData.examplePronunciation = enData.examplePronunciation;
            wordData.koreanTranslation = enData.koreanTranslation;
        } else if (currentTargetLanguage === 'Chinese') {
            const cnData = getChineseWordData(word);
            wordData.koreanPronunciation = cnData.korean;
            wordData.romanization = cnData.pinyin + ' + ' + cnData.korean;
            wordData.example = cnData.example;
            wordData.examplePronunciation = cnData.examplePronunciation;
            wordData.koreanTranslation = cnData.koreanTranslation;
        }
        
        return wordData;
    }
    
    function getJapaneseWordData(word) {
        const wordDatabase = {
            'エンジン': {
                korean: '엔진',
                romaji: 'enjin',
                hiragana: 'えんじん',
                example: 'エンジンの音が大きいです。',
                examplePronunciation: '엔진노 오토가 오키이데스',
                koreanTranslation: '엔진 소리가 큽니다.'
            },
            'ブレーキ': {
                korean: '브레이키',
                romaji: 'burēki',
                hiragana: 'ぶれーき',
                example: 'ブレーキを踏んでください。',
                examplePronunciation: '브레이키오 푼데쿠다사이',
                koreanTranslation: '브레이크를 밟아주세요.'
            },
            'タイヤ': {
                korean: '타이야',
                romaji: 'taiya',
                hiragana: 'たいや',
                example: 'タイヤの空気圧を確認します。',
                examplePronunciation: '타이야노 쿠우키아츠오 카쿠닌시마스',
                koreanTranslation: '타이어의 공기압을 확인합니다.'
            },
            'ドア': {
                korean: '도아',
                romaji: 'doa',
                hiragana: 'どあ',
                example: 'ドアが開いています。',
                examplePronunciation: '도아가 아이테이마스',
                koreanTranslation: '문이 열려있습니다.'
            },
            '窓': {
                korean: '마도',
                romaji: 'mado',
                hiragana: 'まど',
                example: '窓を開けてください。',
                examplePronunciation: '마도오 아케테쿠다사이',
                koreanTranslation: '창문을 열어주세요.'
            },
            '重要': {
                korean: '쥬우요우',
                romaji: 'jūyō',
                hiragana: 'じゅうよう',
                example: 'この部品は重要です。',
                examplePronunciation: '코노 부힌와 쥬우요우데스',
                koreanTranslation: '이 부품은 중요합니다.'
            },
            '技術': {
                korean: '기쥬츠',
                romaji: 'gijutsu',
                hiragana: 'ぎじゅつ',
                example: '新しい技術を開発しました。',
                examplePronunciation: '아타라시이 기쥬츠오 카이하츠시마시타',
                koreanTranslation: '새로운 기술을 개발했습니다.'
            },
            '製造': {
                korean: '세이조우',
                romaji: 'seizō',
                hiragana: 'せいぞう',
                example: '自動車を製造しています。',
                examplePronunciation: '지도우샤오 세이조우시테이마스',
                koreanTranslation: '자동차를 제조하고 있습니다.'
            },
            '品質': {
                korean: '힌시츠',
                romaji: 'hinshitsu',
                hiragana: 'ひんしつ',
                example: '品質管理が大切です。',
                examplePronunciation: '힌시츠칸리가 타이세츠데스',
                koreanTranslation: '품질 관리가 중요합니다.'
            },
            'です': {
                korean: '데스',
                romaji: 'desu',
                hiragana: 'です',
                example: '今日は晴れです。',
                examplePronunciation: '쿄우와 하레데스',
                koreanTranslation: '오늘은 맑습니다.'
            }
        };
        
        const data = wordDatabase[word];
        if (data) {
            return data;
        }
        
        // 기본값 반환
        return {
            korean: '알 수 없음',
            romaji: word,
            hiragana: word,
            example: `${word}は重要です。`,
            examplePronunciation: `${word}와 쥬우요우데스`,
            koreanTranslation: `${word}는 중요합니다.`
        };
    }
    
    function getEnglishWordData(word) {
        const wordDatabase = {
            'engine': {
                korean: '엔진',
                phonetic: 'ˈendʒɪn',
                example: 'The engine is running smoothly.',
                examplePronunciation: '디 엔진 이즈 러닝 스무들리',
                koreanTranslation: '엔진이 부드럽게 작동하고 있습니다.'
            },
            'brake': {
                korean: '브레이크',
                phonetic: 'breɪk',
                example: 'Please apply the brake slowly.',
                examplePronunciation: '플리즈 어플라이 더 브레이크 슬로울리',
                koreanTranslation: '브레이크를 천천히 밟아주세요.'
            },
            'wheel': {
                korean: '휠',
                phonetic: 'wiːl',
                example: 'The wheel is turning smoothly.',
                examplePronunciation: '더 휠 이즈 터닝 스무들리',
                koreanTranslation: '바퀴가 부드럽게 돌고 있습니다.'
            },
            'door': {
                korean: '도어',
                phonetic: 'dɔːr',
                example: 'Close the door carefully.',
                examplePronunciation: '클로즈 더 도어 케어풀리',
                koreanTranslation: '문을 조심히 닫으세요.'
            },
            'window': {
                korean: '윈도우',
                phonetic: 'ˈwɪndoʊ',
                example: 'Open the window for fresh air.',
                examplePronunciation: '오픈 더 윈도우 포 프레시 에어',
                koreanTranslation: '신선한 공기를 위해 창문을 여세요.'
            },
            'car': {
                korean: '카',
                phonetic: 'kɑːr',
                example: 'This car is very efficient.',
                examplePronunciation: '디스 카 이즈 베리 이피션트',
                koreanTranslation: '이 차는 매우 효율적입니다.'
            },
            'technology': {
                korean: '테크놀로지',
                phonetic: 'tekˈnɑːlədʒi',
                example: 'Advanced technology improves safety.',
                examplePronunciation: '어드밴스드 테크놀로지 임프루브즈 세이프티',
                koreanTranslation: '첨단 기술이 안전성을 향상시킵니다.'
            },
            'manufacturing': {
                korean: '매뉴팩처링',
                phonetic: 'ˌmænjuˈfæktʃərɪŋ',
                example: 'Manufacturing processes are automated.',
                examplePronunciation: '매뉴팩처링 프로세시즈 아 오토메이티드',
                koreanTranslation: '제조 과정이 자동화되어 있습니다.'
            },
            'quality': {
                korean: '퀄리티',
                phonetic: 'ˈkwɑːləti',
                example: 'Quality control is essential.',
                examplePronunciation: '퀄리티 컨트롤 이즈 에센셜',
                koreanTranslation: '품질 관리는 필수적입니다.'
            },
            'important': {
                korean: '임포턴트',
                phonetic: 'ɪmˈpɔːrtənt',
                example: 'Safety is very important.',
                examplePronunciation: '세이프티 이즈 베리 임포턴트',
                koreanTranslation: '안전은 매우 중요합니다.'
            }
        };
        
        const cleanWord = word.toLowerCase().replace(/[^a-z]/g, '');
        const data = wordDatabase[cleanWord];
        if (data) {
            return data;
        }
        
        // 기본값 반환
        return {
            korean: word,
            phonetic: word,
            example: `This ${word} is important.`,
            examplePronunciation: `디스 ${word} 이즈 임포턴트`,
            koreanTranslation: `이 ${word}는 중요합니다.`
        };
    }
    
    function getChineseWordData(word) {
        const wordDatabase = {
            '引擎': {
                korean: '인칭',
                pinyin: 'yǐnqíng',
                example: '引擎运转很顺畅。',
                examplePronunciation: '인칭 윈즈완 헌 순창',
                koreanTranslation: '엔진이 매우 부드럽게 작동합니다.'
            },
            '刹车': {
                korean: '샤처',
                pinyin: 'shāchē',
                example: '请慢慢踩刹车。',
                examplePronunciation: '칭 만만 차이 샤처',
                koreanTranslation: '브레이크를 천천히 밟아주세요.'
            },
            '轮胎': {
                korean: '룬타이',
                pinyin: 'lúntāi',
                example: '轮胎需要检查。',
                examplePronunciation: '룬타이 쉬야오 지엔차',
                koreanTranslation: '타이어를 점검해야 합니다.'
            },
            '门': {
                korean: '먼',
                pinyin: 'mén',
                example: '请关门。',
                examplePronunciation: '칭 관 먼',
                koreanTranslation: '문을 닫아주세요.'
            },
            '窗户': {
                korean: '창후',
                pinyin: 'chuānghu',
                example: '打开窗户通风。',
                examplePronunciation: '다카이 창후 통펑',
                koreanTranslation: '창문을 열어서 환기하세요.'
            },
            '汽车': {
                korean: '치처',
                pinyin: 'qìchē',
                example: '这辆汽车很先进。',
                examplePronunciation: '저량 치처 헌 시엔진',
                koreanTranslation: '이 자동차는 매우 첨진합니다.'
            },
            '技术': {
                korean: '지슈',
                pinyin: 'jìshù',
                example: '新技术提高了效率。',
                examplePronunciation: '신 지슈 티가오러 샤오뤼',
                koreanTranslation: '새로운 기술이 효율성을 높였습니다.'
            },
            '制造': {
                korean: '즈자오',
                pinyin: 'zhìzào',
                example: '制造过程很复杂。',
                examplePronunciation: '즈자오 구어청 헌 푸자',
                koreanTranslation: '제조 과정이 매우 복잡합니다.'
            },
            '质量': {
                korean: '즈량',
                pinyin: 'zhìliàng',
                example: '质量控制很重要。',
                examplePronunciation: '즈량 콩즈 헌 중야오',
                koreanTranslation: '품질 관리가 매우 중요합니다.'
            },
            '重要': {
                korean: '중야오',
                pinyin: 'zhòngyào',
                example: '安全很重要。',
                examplePronunciation: '안취안 헌 중야오',
                koreanTranslation: '안전이 매우 중요합니다.'
            }
        };
        
        const data = wordDatabase[word];
        if (data) {
            return data;
        }
        
        // 기본값 반환
        return {
            korean: word,
            pinyin: word,
            example: `这个${word}很重要。`,
            examplePronunciation: `저거 ${word} 헌 중야오`,
            koreanTranslation: `이 ${word}는 매우 중요합니다.`
        };
    }
    
    function makeTextHoverable(text, container) {
        const words = text.split(/(\s+|[,.!?;:])/);
        container.innerHTML = '';
        
        words.forEach(word => {
            if (word.trim() && !/^[,.!?;:\s]+$/.test(word)) {
                const hoverableWord = createHoverableWord(word.trim());
                container.appendChild(hoverableWord);
                
                // 공백이나 구두점 추가
                const nextWordIndex = words.indexOf(word) + 1;
                if (nextWordIndex < words.length && /^[,.!?;:\s]+$/.test(words[nextWordIndex])) {
                    container.appendChild(document.createTextNode(words[nextWordIndex]));
                }
            } else if (/^[,.!?;:\s]+$/.test(word)) {
                // 이미 처리된 구두점이 아닌 경우에만 추가
                if (container.lastChild && container.lastChild.textContent !== word) {
                    container.appendChild(document.createTextNode(word));
                }
            }
        });
    }
    
    targetLangTitle.innerText = `${langDisplayNames[currentTargetLanguage]} 번역 결과`;

</script>
</body>
</html>
